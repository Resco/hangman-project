<!DOCTYPE html> 
<html lang="en">
	<head>
		<meta charset="utf-8" />		
		<title>Mastermind</title>
		<meta name="description" content="A simple implementation of Hangman" >
	</head>
	
	<body>
		<header>
			<h1>This is my Mastermind</h1>
			<nav id="navigation">
			
				<div id='buttons'>
					<a href='javascript:on_game()'> Game </a>
					<a href='javascript:on_g_rank()'> Ranking </a>
					<button type="button" id="cookie_del">Delete</button>
				</div>
				
				<div id='target_general'>
				</div>
				
			</nav>
		</header>
		
		<div id='main'>
			
			<div id='display'>&nbsp;</div>
			
			<section id='log'>
				<h3>Login</h3>
				<form id='login'>
			        <label for='nick_login'>Your Nickname</label><br/>
			        <input type="text" class="login_input" name="nick_login" value="" id='nick_login'/><br/>
			
			        <label for="password_login">Your Password</label><br/>
			        <input type="password" class="login_input" name="password_login" value="" id="password_login"/><br/>
			
			        <input type="submit" value="Login" />
	   			</form>
			</section>
				
			<section id='reg'>
				<h3>Register</h3>
				<form id='register'>
					<label for='nick_reg'>Nickname</label><br/>
				    <input type="text" class="register_input" name="nick_reg" value="" id='nick_reg'/><br/>
				
				    <label for="password_reg">Password</label><br/>
				    <input type="password" class="register_input" name="password_reg" value="" id="password_reg"/><br/>
						
					<label for="re_password_reg">Repeat Password</label><br/>
				    <input type="password" class="register_input" name="re_password_reg" value="" id="re_password_reg"/><br/>
						
					<label for='mail_reg'>Mail</label><br/>
				    <input type='text' class="register_input" name="mail_reg" value="" id='mail_reg'/><br/>
						
				    <input type="submit" value="Register" />    
	      		</form>
			</section>	
			
			<section id='new_g'>
				<h3>Your game</h3>
				<div id='info_game'>
					<button type="button" id="newgame">New Game</button>
					<p id='general'>Let's play a new game!</p>
					<p id='answer'>&nbsp;</p>
					<p id='game_code' style='display:none'>&nbsp;</p>
				</div>
				
				<form id='move'>	
					<label for='seq'>Sequence</label><br/>
				    <input type='text' autocomplete="off" name="seq" value="" id='seq' maxlength="4"/><br/>
				    <input type="submit" value="Send" />    
	      		</form>
	      		
			</section>
			
			<section id='rank'>
				<h3>General ranking</h3>
				<div id='ranking'>
				</div>
				
			</section>
			
			
				
		</div>
		
		<footer>
			<div id='author'>Autore: Luca Resconi XXXXXX</div>
			<div id='exam'>Appello: Settembre 2014</div>
		</footer>
		
		<script id='navigate-template' type="application/x-tmpl-mustache">
      		Welcome {{description}}. Your average is {{average}} on {{games}} games.
    	</script>
    	
    	<script id='moves-template' type="application/x-tmpl-mustache">
      		<ul>
      			{{ #items }}
        		<li> {{ move_id }}: {{ move }} : {{result}}</li>
      			{{ /items }}
      		</ul>
    	</script>
    	
    	<script id="global_template" type="application/x-tmpl-mustache">
		<table>
			<tr>
				<th>Pos</th>
				<th>Users</th>
				<th>Average score</th>
				<th>Games</th>
			</tr>
			{{#players}}
			<tr>
				<td id="pos">{{ pos }}</td>
				<td id="user"><a href='javascript:on_player_history("{{id}}")'> {{id}} </a></td>
				<td id="score">{{ avg }}</td>
				<td id="ngames">{{ games }}</td>
			</tr>
			{{/players}}
		</table>
		</script>
		
		<script id="history_template" type="application/x-tmpl-mustache">
		<table>
			<tr>
				<th>Started</th>
				<th>Finished</th>
				<th>Score</th>
			</tr>
			{{#games}}
			<tr>
				<td id="started"> {{ started }} </td>
				<td id="finished"> {{finished}} </td>
				<td id="score"> {{ score }} </td>
			</tr>
			{{/games}}
		</table>
		
		<button type="button" id="back">Back</button>
		<script>$("#back").click(on_g_rank);</script>
		
	</script>
		
		<script src='/js/lib/jquery-1.10.2.min.js'></script>
		<script src='/js/lib/mustache.js'></script>
		<script src='/js/game.js'></script>
    	<script src='/js/game_moves_view.js'></script>
		
		<script>
		
			var game;
			var came_id;
			var session_id;
			
			function render_template_navigate(name, avg, games) {
        		var template = $('#navigate-template').html();
        		var rendered = Mustache.render(template, {
          			description: name,
          			average : avg,
          			games : games
        		});
        		$("#target_general").html(rendered);
      		}
			
			$(document).ready(function() {
				 
        		$("#register").submit(on_register);
				$("#login").submit(on_login);
				$("#move").submit(on_move);
				$("#newgame").click(on_new_game);
				$("#rank_button").click(on_g_rank);
				$("#cookie_del").click(on_cookie_del);
				
				
				$("#buttons").hide();
				$("#new_g").hide();
				$("#rank").hide();
				check_log();
      		});
      		
      		function on_cookie_del(){
      			console.log("username='" + session_id + "'; expires=Thu, 01 Jan 1970 00:00:00 UTC");
      			document.cookie = "session_id='" + session_id + "'; expires=Thu, 01 Jan 1970 00:00:00 UTC"; 
      		}
      		
      		<!--Navigation Buttons Functions-->
      		
      		function on_g_rank(){
      			$("#new_g").hide();
      			$("#rank").show();
      			on_g_rank_builder();
      		}
      		
      		function on_game(){
      			$("#new_g").show();
      			$("#rank").hide();
      		}
      		
      		<!--Global Rank Builder-->
      		
      		function on_g_rank_builder(){
      			$.ajax({
          			url: '/g_rank',
          			method: 'get',
          			success: on_g_rank_builder_success,
        		});	
      		}
      		
      		function on_g_rank_builder_success (data){
      			$("#ranking").text(JSON.stringify(data));
      			var template = $('#global_template').html();
				var rendered = Mustache.render(template, data);
				$("#ranking").html(rendered);
      		}
      		
     		<!--Player History-->
      		
      		function on_player_history(id){
      			$.ajax({
          			url: '/p_hist',
          			method: 'post',
          			data: {
            			nickname: id,
          			},
          			success: on_player_history_success,
        		});	
      		}
      		
      		function on_player_history_success (data){
      			$("#ranking").text(JSON.stringify(data));
      			var template = $('#history_template').html();
				var rendered = Mustache.render(template, data);
				$("#ranking").html(rendered);
      		}
      		
      		<!--New Game-->
      		
      		function on_new_game() {
      			$("#move").show();
      			//creazione della partita
      			$.ajax({
          			url: '/newgame',
          			method: 'get',
          			success: on_new_game_success,
        		});	
      		}
      		
      		function on_new_game_success (data){
      			$("#answer").text("");
      			$("#code").text(data.code);
      			$("#general").text("Try to guess, if you can... ");
      			$("#game_code").text(data.game_id);
      			game_id = data.game_id
      			game = new Game();
      			var moves_view = new GameMovesView("#moves-template", "#answer");
      			game.add_observer(moves_view);
      		}
      		
      		<!--Move-->
      		
      		function on_move (){
      			$.ajax({
          			url: '/move',
          			method: 'post',
          			success: on_move_success,
          			data: {
            			game_id: game_id,
            			sequence: $("#seq").val(),
          			},
        		});
        		return false;
      		}
      		
      		function on_move_success (data){
      			
      			game.on_move(data.move_id, data.move, data.result);
      			if(data.result=="++++"){
      				$("#move").hide();
      				$("#general").text("Well done! YOU WIN!");
      				render_template_navigate(data.description, data.average, data.games);
      			}
      			$("#move")[0].reset();
      		}
			
			<!--Check Log-->
			
			function check_log() {
        		$.ajax({
          			url: '/logged',
          			method: 'get',
          			success: on_login_success,
        		})
      		}
			
			<!--Register-->
			
			function on_register() {
				$(".register_input").attr("style", "border-color: default");
				$(".login_input").attr("style", "border-color: default");
        		$.ajax({
          			url: '/register',
          			method: 'post',
          			success: on_register_success,
          			error: on_register_error,
          			data: {
            			nickname: $("#nick_reg").val(),
            			password: $("#password_reg").val(),
						re_password: $("#re_password_reg").val(),
						mail: $("#mail_reg").val(),
          			},
        		});
        	return false;
      		}
			
			function on_register_success(data) {
				if(data.description=="pw_leng"){
					$("#display").text("Password too short (8 characters at least)");
					$("#password_reg").attr("style", "border-color:red");
				}
				else if(data.description=="pw_equal"){
					$("#display").text("Please digit the same password twice");
					$("#re_password_reg").attr("style", "border-color:red");
				}
				else if(data.description=="mail"){
					$("#display").text("Your password must contain @");
					$("#mail_reg").attr("style", "border-color:red");
				}
				else if(data.description=="nick_exists"){
					$("#display").text("Please digit another nickname");
					$("#nick_reg").attr("style", "border-color:red");
				}
				else{
					$("#display").text(data.description);
					$("#register")[0].reset();
					$("#login")[0].reset();
				}
				
				
      		}

      		function on_register_error(data) {
				$("#display").text(JSON.stringify(data.responseJSON));
      		}
			
			<!--Login-->
			
			function on_login() {
				$(".register_input").attr("style", "border-color: default");
				$(".login_input").attr("style", "border-color: default");
        		$.ajax({
          			url: '/authenticate',
          			method: 'post',
          			success: on_login_success,
          			error: on_login_error,
          			data: {
            			nickname: $("#nick_login").val(),
            			password: $("#password_login").val(),
          			},
        		});
        	return false;
      		}
			
			function on_login_success(data) {
				if(data.description=="pw"){
					$("#display").text("Try another password");
					$("#password_login").attr("style", "border-color:red");
				}
				else if(data.description=="nick_exist"){
					$("#display").text("Try another nickname");
					$("#nick_login").attr("style", "border-color:red");
				}
				else{
				$("#login")[0].reset();
				$("#log").hide();
				$("#reg").hide();
				$("#display").text("");
				$("#register")[0].reset();
				$("#login")[0].reset();
				session_id = data.session_id;
				
				$("#buttons").show();
				
				render_template_navigate(data.description, data.average, data.games);
        		
      			}
      			
      		}

      		function on_login_error(data) {
				$("#display").text(JSON.stringify(data.responseJSON));
      		}
      		
	  
	  	</script>
	</body>
</html>
