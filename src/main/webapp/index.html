<!DOCTYPE html> 
<html lang="en">
	<head>
		<meta charset="utf-8" />		
		<title>Mastermind</title>
		<meta name="description" content="A simple implementation of Hangman" >
	</head>
	
	<body>
		<header>
			<h1>This is my Masterminds</h1>
			<nav id="navigation">
				<div id='buttons'>
				</div>
				
				<div id='target_general'>
				</div>
			</nav>
		</header>
		
		<div id='main'>
			
			<div id='display'>&nbsp;</div>
			
			<section id='log'>
				<h3>Login</h3>
				<form id='login'>
			        <label for='nick_login'>Your Nickname</label><br/>
			        <input type="text" name="nick_login" value="" id='nick_login'/><br/>
			
			        <label for="password_login">Your Password</label><br/>
			        <input type="password" name="password_login" value="" id="password_login"/><br/>
			
			        <input type="submit" value="Login" />
	   			</form>
			</section>
				
			<section id='reg'>
				<h3>Register</h3>
				<form id='register'>
					<label for='nick_reg'>Nickname</label><br/>
				    <input type="text" name="nick_reg" value="" id='nick_reg'/><br/>
				
				    <label for="password_reg">Password</label><br/>
				    <input type="password" name="password_reg" value="" id="password_reg"/><br/>
						
					<label for="re_password_reg">Repeat Password</label><br/>
				    <input type="password" name="re_password_reg" value="" id="re_password_reg"/><br/>
						
					<label for='mail_reg'>Mail</label><br/>
				    <input type='text' name="mail_reg" value="" id='mail_reg'/><br/>
						
				    <input type="submit" value="Register" />    
	      		</form>
			</section>	
			
			<section id='new_g'>
				<h3>Your game</h3>
				<div id='info_game'>
					<p id='general'>&nbsp;</p>
					<p id='code'>&nbsp;</p>
					<p id='answer'>&nbsp;</p>
				</div>
				
				<form id='move'>	
					<label for='seq'>Sequence</label><br/>
				    <input type='text' name="seq" value="" id='seq' maxlength="4"/><br/>
				    <input type="submit" value="Send" />    
	      		</form>
	      		
			</section>
			
			<script id='moves-template' type="application/x-tmpl-mustache">
      			<ul>
      				{{ #items }}
        			<li> {{ move_id }}: {{ move }} : {{result}}</li>
      				{{ /items }}
      			</ul>
    		</script>
				
		</div>
		
		<footer>
			<div id='author'>Autore: Luca Resconi XXXXXX</div>
			<div id='exam'>Appello: Settembre 2014</div>
		</footer>
		
		<script id='navigate-template' type="application/x-tmpl-mustache">
      		Welcome {{description}}. Your average is {{average}} on {{games}} games.
    	</script>
		
		<script src='/js/lib/jquery-1.10.2.min.js'></script>
		<script src='/js/lib/mustache.js'></script>
		<script src='/js/game.js'></script>
    	<script src='/js/game_moves_view.js'></script>
		
		<script>
		
			var game;
		
			function render_template_navigate(name, avg, games) {
        		var template = $('#navigate-template').html();
        		var rendered = Mustache.render(template, {
          			description: name,
          			average : avg,
          			games : games
        		});
        		$("#target_general").html(rendered);
      		}
			
			$(document).ready(function() {
        		$("#register").submit(on_register);
				$("#login").submit(on_login);
				$("#move").submit(on_move);
				
				$("#new_g").fadeOut();
				check_log();
      		});
      		
      		function on_new_game() {
      			$("#new_g").fadeIn();
      			$("#move").fadeIn();
      			//creazione della partita
      			$.ajax({
          			url: '/newgame',
          			method: 'get',
          			success: on_new_game_success,
        		});	
      		}
      		
      		function on_new_game_success (data){
      			$("#code").text(data.code);
      			$("#general").text(data.game_id);
      			game = new Game();
      			var moves_view = new GameMovesView("#moves-template", "#answer");
      			game.add_observer(moves_view);
      		}
      		
      		function on_move (){
      			$.ajax({
          			url: '/move',
          			method: 'post',
          			success: on_move_success,
          			data: {
            			game_id: $("#general").text(),
            			sequence: $("#seq").val(),
          			},
        		});
        		return false;
      		}
      		
      		function on_move_success (data){
      			
      			game.on_move(data.move_id, data.move, data.result);
      			if(data.result=="++++"){
      				$("#move").fadeOut();
      				$("#general").text("Weel done! YOU WIN!");
      				render_template_navigate(data.description, data.average, data.games);
      			}
      			$("#move")[0].reset();
      		}
			
			function check_log() {
        		$.ajax({
          			url: '/logged',
          			method: 'get',
          			success: on_login_success,
        		})
      		}
			
			
			function on_register() {
        		$.ajax({
          			url: '/register',
          			method: 'post',
          			success: on_register_success,
          			error: on_register_error,
          			data: {
            			nickname: $("#nick_reg").val(),
            			password: $("#password_reg").val(),
						re_password: $("#re_password_reg").val(),
						mail: $("#mail_reg").val(),
          			},
        		});
        	return false;
      		}
			
			function on_register_success(data) {
				$("#display").text(data.description);
				$("#register")[0].reset();
      		}

      		function on_register_error(data) {
				$("#display").text(JSON.stringify(data.responseJSON));
      		}
			
			function on_login() {
        		$.ajax({
          			url: '/authenticate',
          			method: 'post',
          			success: on_login_success,
          			error: on_login_error,
          			data: {
            			nickname: $("#nick_login").val(),
            			password: $("#password_login").val(),
          			},
        		});
        	return false;
      		}
			
			function on_login_success(data) {
				$("#login")[0].reset();
				$("#log").fadeOut();
				$("#reg").fadeOut();
				$("#display").text("");
				
				
				$("#buttons").html( '<button type="button" id="newgame">New Game</button>' );
				
				render_template_navigate(data.description, data.average, data.games);
        		
      			$("#newgame").click(on_new_game);
      			
      		}

      		function on_login_error(data) {
				$("#display").text(JSON.stringify(data.responseJSON));
      		}
      		
	  
	  	</script>
	</body>
</html>
